<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我回来了！"><title>Android Library工程打成混淆jar包 | SunQiang's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android Library工程打成混淆jar包</h1><a id="logo" href="/.">SunQiang's Blog</a><p class="description">我爱学习，学习爱我</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/diary/"><i class="fa fa-heart"> 心情</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android Library工程打成混淆jar包</h1><div class="post-meta">May 17, 2016<span> | </span><span class="category"><a href="/categories/编程技术/">编程技术</a></span></div><a data-disqus-identifier="2016/05/17/20160517_Android Library工程打成混淆jar包/" href="/2016/05/17/20160517_Android Library工程打成混淆jar包/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#导出jar包"><span class="toc-number">1.</span> <span class="toc-text">导出jar包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用proguard混淆"><span class="toc-number">2.</span> <span class="toc-text">使用proguard混淆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proguard配置文件"><span class="toc-number">3.</span> <span class="toc-text">Proguard配置文件</span></a></li></ol></div></div><div class="post-content"><p>在项目中使用eclipse编写了一个Android的Library工程，现需要将工程导出成jar包，并且混淆，然后提交给外部使用。要求除了外部需要调用的接口，其他部分需要proguard混淆和优化。</p>
<p>下面是实现的过程。</p>
<h2 id="导出jar包"><a href="#导出jar包" class="headerlink" title="导出jar包"></a>导出jar包</h2><p>获取未混淆的jar包，这里有两种方式：</p>
<ol>
<li>使用eclipse的export导出功能</li>
<li>直接从bin文件夹获取</li>
</ol>
<p>1方法就是通用的方法，先在library工程上右键，选择export，然后选择java标签下的jar file，然后将除了src之外的所有文件夹取消勾选，导出即可，如下图：</p>
<p><img src="/media/Android Library工程打成混淆jar包1.png" alt="附件1"></p>
<p><img src="/media/Android Library工程打成混淆jar包2.png" alt="附件2"></p>
<p>而2方法简单的多。library工程在被其他工程依赖时，会自动在bin目录下生成编译好的jar包，直接拿此jar包用即可。经过反编译查看此jar包与export导出的jar包的内容是一样的，可放心使用。</p>
<h2 id="使用proguard混淆"><a href="#使用proguard混淆" class="headerlink" title="使用proguard混淆"></a>使用proguard混淆</h2><p>平时在eclipse打混淆包时，eclipse会自动找到你在project.properties中定义的proguard配置，并通过命令行调用proguard进行混淆、优化。而这里，我们可以使用proguard提供的gui工具进行混淆。</p>
<p>gui工具在android的sdk目录下的tools/proguard/lib/proguardgui.jar，双击打开即可。界面如下：</p>
<p><img src="/media/Android Library工程打成混淆jar包3.png" alt="附件3"></p>
<p>1.先点击底部的load configuration，加载写好的配置文件（请先学习proguard的配置语法）：</p>
<p><img src="/media/Android Library工程打成混淆jar包4.png" alt="附件4"></p>
<p>2.然后右边的选项点到Input/Output选项，如下图：</p>
<p><img src="/media/Android Library工程打成混淆jar包5.png" alt="附件5"></p>
<p>3.在上面add input添加要混淆的jar包，add output添加要生成的jar包。（这里很不合理，因为我要生成的jar包肯定是现在还不存在的，但是它在选择框里要求你选择一个已经存在的jar包。没办法，这里我先用”touch des.jar”新建了一个空白的文件，然后才选的）。</p>
<p>4.然后在下面添加依赖jar包。因为我的工程只用到了android.jar，所以就只把它添加进去了。</p>
<p>5.然后左侧的下面几个看不懂的tab就不要点了，也不要点下面的next跟着它的节奏走，因为proguard的配置我们之前已经加载进去了。所以现在直接点Process标签，然后点击最下方的“Process!”按钮。过一会儿就会得到优化好的、混淆的jar包。</p>
<p>如果过程中出现问题，那么一定是proguard的配置文件写的不对！修改此文件，然后重复上述流程。</p>
<h2 id="Proguard配置文件"><a href="#Proguard配置文件" class="headerlink" title="Proguard配置文件"></a>Proguard配置文件</h2><p>其实核心还是这个文件，首先，我在网上看到一个通用的配置：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">optimizationpasses <span class="number">5</span></span></div><div class="line">-<span class="ruby">dontusemixedcaseclassnames</span></div><div class="line">-<span class="ruby">dontskipnonpubliclibraryclasses</span></div><div class="line">-<span class="ruby">dontpreverify</span></div><div class="line">-<span class="ruby">verbose</span></div><div class="line">-<span class="ruby">optimizations !code/simplification/arithmetic,!field/*,!<span class="class"><span class="keyword">class</span>/<span class="title">merging</span>/*</span></span></div><div class="line"></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Activity</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Application</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Service</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">BroadcastReceiver</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">ContentProvider</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">backup</span>.<span class="title">BackupAgentHelper</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">preference</span>.<span class="title">Preference</span></span></span></div><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">android</span>.<span class="title">vending</span>.<span class="title">licensing</span>.<span class="title">ILicensingService</span></span></span></div><div class="line"></div><div class="line">-<span class="ruby">keepclasseswithmembernames <span class="class"><span class="keyword">class</span> * &#123;</span></span></div><div class="line">    native &lt;methods&gt;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepclasseswithmembers <span class="class"><span class="keyword">class</span> * &#123;</span></span></div><div class="line">    public &lt;init&gt;(android.content.Context, android.util.AttributeSet);</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepclasseswithmembers <span class="class"><span class="keyword">class</span> * &#123;</span></span></div><div class="line">    public &lt;init&gt;(android.content.Context, android.util.AttributeSet, int);</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="title">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Activity</span> &#123;</span></span></div><div class="line">   public void *(android.view.View);</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepclassmembers enum * &#123;</span></div><div class="line">    public static **[] values();</div><div class="line">    public static ** valueOf(java.lang.String);</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keep <span class="class"><span class="keyword">class</span> * <span class="title">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> &#123;</span></span></div><div class="line">  public static final android.os.Parcelable$Creator *;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>直接使用此配置作为混淆文件是不行的，我100k左右的jar包经过上述配置混淆后只剩8k，反编译后发现只剩下了寥寥几个类。原来是我的对外接口没有暴露出来，结果被当作无用的代码优化掉了。</p>
<p>因此对外接口需要暴露出来不混淆，在配置文件底部增加：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">test</span>.<span class="title">MyAgent</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> &lt;fields&gt;;</div><div class="line">	<span class="keyword">public</span> &lt;methods&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中MyAgent就是我的对外接口。再次混淆就会发现混淆后的jar包果然变大了。</p>
<p>然而，此时发现其实还有一些类是需要对外暴露的。于是继续添加配置：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">test</span>.<span class="title">MyInterface</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> &lt;fields&gt;;</div><div class="line">	<span class="keyword">public</span> &lt;methods&gt;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">test</span>.<span class="title">MyInterface</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> &lt;fields&gt;;</div><div class="line">	<span class="keyword">public</span> &lt;methods&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里规定不混淆MyInterface以及实现了MyInterface接口的文件。</p>
<p>然后还有问题，我将所有的枚举都作为内部类放在了一个EnumUtil中，这些枚举外部也有调用的需要。因此添加：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">test</span>.<span class="title">utils</span>.<span class="title">EnumUtil</span> &#123;</span></span></div><div class="line">	*;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepnames <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">test</span>.<span class="title">utils</span>.<span class="title">EnumUtil</span>$* &#123;</span></span></div><div class="line">	*;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-<span class="ruby">keepattributes InnerClasses</span></div></pre></td></tr></table></figure>
<p>规定不混淆EnumUtil中的内部类即可。</p>
<p>2016.05.22 update:</p>
<p>jar包里如果用到资源文件千万别用反射的方法获取，因为混淆之后会出问题。。。先是我，然后是两个同事都掉进了<a href="http://blog.csdn.net/xiaanming/article/details/9257853" target="_blank" rel="external">这篇文章</a>的坑里了。</p>
<p>直接用context.getResources().getIdentify()的方法获取资源id即可。</p>
<p>EOF</p>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/Proguard/">Proguard</a></div><div class="post-nav"><a href="/2016/05/22/20160522_直男癌眼中的欢乐颂/" class="pre">直男癌眼中的欢乐颂</a><a href="/2016/05/10/20160510_给博客添加Timeline/" class="next">给博客添加Timeline</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'sunqiangsblog';
var disqus_identifier = '2016/05/17/20160517_Android Library工程打成混淆jar包/';
var disqus_title = 'Android Library工程打成混淆jar包';
var disqus_url = 'http://channingsun.github.io/2016/05/17/20160517_Android Library工程打成混淆jar包/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//sunqiangsblog.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://channingsun.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/归纳汇总/">归纳汇总</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情随笔/">心情随笔</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/精品转载/">精品转载</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程技术/">编程技术</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Proguard/" style="font-size: 15px;">Proguard</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/思考/" style="font-size: 15px;">思考</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/影评/" style="font-size: 15px;">影评</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/追星/" style="font-size: 15px;">追星</a> <a href="/tags/Unity/" style="font-size: 15px;">Unity</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/20171017_windows配置jenkins/">Windows配置Jenkins的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/20171017_Docker学习笔记1/">Docker读书笔记1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/20170611_Unity与Android交互小结/">Unity与Android交互小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/20170606_Unity AssetBundle使用小结/">Unity AssetBundle使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/31/20161231_2016碎碎念汇总/">心情2016</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/01/20160601_Git学习笔记/">Git学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/29/20160529_追星与脑残粉/">追星与脑残粉</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/22/20160522_直男癌眼中的欢乐颂/">直男癌眼中的欢乐颂</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/17/20160517_Android Library工程打成混淆jar包/">Android Library工程打成混淆jar包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/20160510_给博客添加Timeline/">给博客添加Timeline</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//sunqiangsblog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.leocook.org/" title="跨界的IT博客" target="_blank">跨界的IT博客</a><ul></ul><a href="https://www.haomwei.com/" title="屠夫9441的博客" target="_blank">屠夫9441的博客</a><ul></ul><a href="https://blog.jamespan.me/" title="James Pan's Blog" target="_blank">James Pan's Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">SunQiang's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>